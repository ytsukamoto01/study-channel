<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編集・削除機能テスト - すたでぃちゃんねる</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .test-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #1976d2;
        }
        .test-thread {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: white;
        }
        .thread-actions {
            margin-top: 10px;
        }
        .edit-btn, .delete-btn {
            margin-right: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .edit-btn {
            background: #4caf50;
            color: white;
        }
        .delete-btn {
            background: #f44336;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background: #2196f3;
            color: white;
        }
        .btn-secondary {
            background: #666;
            color: white;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>編集・削除機能テスト</h1>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="test-info">
                <h3><i class="fas fa-info-circle"></i> テスト情報</h3>
                <p>このページは編集・削除機能のテスト用です。</p>
                <p><strong>テストサーバー:</strong> ポート 3001</p>
                <p><strong>ユーザーフィンガープリント:</strong> <span id="userFingerprint"></span></p>
            </div>
            
            <div class="loading" id="loading">読み込み中...</div>
            <div id="threadsList"></div>
        </div>
    </main>

    <!-- 編集モーダル -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>スレッド編集</h3>
            <form id="editForm">
                <div class="form-group">
                    <label for="editTitle">タイトル:</label>
                    <input type="text" id="editTitle" required>
                </div>
                <div class="form-group">
                    <label for="editCategory">カテゴリ:</label>
                    <select id="editCategory">
                        <option value="テスト">テスト</option>
                        <option value="一般">一般</option>
                        <option value="質問">質問</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editSubcategory">サブカテゴリ:</label>
                    <input type="text" id="editSubcategory">
                </div>
                <div class="form-group">
                    <label for="editContent">内容:</label>
                    <textarea id="editContent" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editHashtags">ハッシュタグ (カンマ区切り):</label>
                    <input type="text" id="editHashtags">
                </div>
                <div>
                    <button type="submit" class="btn btn-primary">更新</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">キャンセル</button>
                </div>
                <input type="hidden" id="editThreadId">
            </form>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        // テスト用の設定
        const TEST_API_BASE = 'http://localhost:3001'; // テストサーバー
        let FP = null;

        // ユーザーフィンガープリントを生成・表示
        document.addEventListener('DOMContentLoaded', () => {
            try {
                FP = generateUserFingerprint();
                document.getElementById('userFingerprint').textContent = FP;
                console.log('Generated fingerprint:', FP);
                loadMyThreads();
            } catch(e) {
                console.error('Error generating fingerprint:', e);
                FP = 'fallback-fp-' + Date.now();
                document.getElementById('userFingerprint').textContent = FP;
                loadMyThreads();
            }
        });

        // スレッド一覧を読み込み
        async function loadMyThreads() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                const response = await fetch(`${TEST_API_BASE}/api/tables/threads?user_fingerprint=${encodeURIComponent(FP)}`);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const threads = data.data || [];
                
                displayThreads(threads);
            } catch (error) {
                console.error('Error loading threads:', error);
                document.getElementById('threadsList').innerHTML = `
                    <div style="color: red; padding: 20px;">
                        <h3>エラーが発生しました</h3>
                        <p>${error.message}</p>
                        <p>テストサーバー (${TEST_API_BASE}) が起動していることを確認してください。</p>
                    </div>
                `;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // スレッドを表示
        function displayThreads(threads) {
            const container = document.getElementById('threadsList');
            
            if (threads.length === 0) {
                container.innerHTML = '<p>スレッドが見つかりませんでした。</p>';
                return;
            }

            container.innerHTML = threads.map(thread => `
                <div class="test-thread">
                    <h4>${escapeHtml(thread.title)}</h4>
                    <p><strong>カテゴリ:</strong> ${escapeHtml(thread.category)} ${thread.subcategory ? '- ' + escapeHtml(thread.subcategory) : ''}</p>
                    <p><strong>内容:</strong> ${escapeHtml(thread.content)}</p>
                    <p><strong>ハッシュタグ:</strong> ${(thread.hashtags || []).map(tag => '#' + escapeHtml(tag)).join(' ')}</p>
                    <p><strong>作成者:</strong> ${escapeHtml(thread.author_name)} (FP: ${escapeHtml(thread.user_fingerprint)})</p>
                    <div class="thread-actions">
                        <button class="edit-btn" onclick="openEditModal('${thread.id}', ${escapeHtml(JSON.stringify(thread))})">
                            <i class="fas fa-edit"></i> 編集
                        </button>
                        <button class="delete-btn" onclick="deleteThread('${thread.id}')">
                            <i class="fas fa-trash"></i> 削除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 編集モーダルを開く
        function openEditModal(threadId, threadData) {
            document.getElementById('editThreadId').value = threadId;
            document.getElementById('editTitle').value = threadData.title || '';
            document.getElementById('editCategory').value = threadData.category || 'テスト';
            document.getElementById('editSubcategory').value = threadData.subcategory || '';
            document.getElementById('editContent').value = threadData.content || '';
            document.getElementById('editHashtags').value = (threadData.hashtags || []).join(', ');
            
            document.getElementById('editModal').style.display = 'block';
        }

        // 編集モーダルを閉じる
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // 編集フォーム送信
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const threadId = document.getElementById('editThreadId').value;
            const formData = {
                user_fingerprint: FP,
                title: document.getElementById('editTitle').value.trim(),
                category: document.getElementById('editCategory').value,
                subcategory: document.getElementById('editSubcategory').value.trim() || null,
                content: document.getElementById('editContent').value.trim(),
                hashtags: document.getElementById('editHashtags').value.split(',').map(s => s.trim()).filter(Boolean)
            };

            try {
                console.log('Sending PATCH request:', formData);
                
                const response = await fetch(`${TEST_API_BASE}/api/tables/threads/${threadId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`PATCH failed: ${response.status}`);
                }

                const result = await response.json();
                console.log('PATCH success:', result);
                
                closeEditModal();
                alert('編集が完了しました！');
                loadMyThreads(); // リロード
                
            } catch (error) {
                console.error('Edit error:', error);
                alert('編集に失敗しました: ' + error.message);
            }
        });

        // スレッド削除
        async function deleteThread(threadId) {
            if (!confirm('このスレッドを削除しますか？')) return;

            try {
                console.log('Sending DELETE request for thread:', threadId);
                
                const response = await fetch(`${TEST_API_BASE}/api/tables/threads/${threadId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_fingerprint: FP })
                });

                if (!response.ok) {
                    throw new Error(`DELETE failed: ${response.status}`);
                }

                console.log('DELETE success');
                alert('削除が完了しました！');
                loadMyThreads(); // リロード
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('削除に失敗しました: ' + error.message);
            }
        }

        // HTMLエスケープ関数（もしcommon.jsにない場合）
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>